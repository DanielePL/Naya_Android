[phases.setup]
nixPkgs = ["python311", "python311Packages.pip", "python311Packages.virtualenv", "python311Packages.opencv4", "ffmpeg", "mesa", "libglvnd", "glib", "xorg.libSM", "xorg.libXrender", "xorg.libXext"]

[phases.install]
cmds = [
    "python -m venv /opt/venv",
    ". /opt/venv/bin/activate && pip install --upgrade pip",
    ". /opt/venv/bin/activate && pip install -r requirements.txt",
    "chmod +x setup_libs.sh",
    "bash setup_libs.sh"
]

[start]
cmd = ". /opt/venv/bin/activate && cd /app && LD_LIBRARY_PATH=/app/lib:$LD_LIBRARY_PATH PYTHONPATH=/app:$PYTHONPATH uvicorn prometheus_backend.main:app --host 0.0.0.0 --port $PORT"
